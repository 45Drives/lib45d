name: publish-api-doc

# Trigger this when a pull request is merged (which implies pushing to master).
on:
  push:
    branches:
      - main

jobs:
  api-doc:
    runs-on: self-hosted
    steps:
    - name: Git Checkout
      uses: actions/checkout@v2
    - name: Create clean gh-pages branch
      run:  git checkout -b gh-pages
    - name: Generate autodocs
      run:  make docs
    - name: Move generated autodocs to target directory
      run:  mv doc/html api-doc
    - name: Add generated autodocs to Git repo in the gh-pages branch
      run:  |
        git config --global user.email "joshuaboud@hotmail.com"
        git config --global user.name  "$GITHUB_WORKFLOW GitHub action"
        git add api-doc
        git commit -am "Generated API doc"
    - name: Publish autodocs as GitHub pages
      run:  git push -f origin gh-pages:gh-pages
    - name: Result URLs
      run:  |
        REPO_OWNER=$(echo $GITHUB_REPOSITORY | cut -d '/' -f 1)
        REPO_NAME=$(echo $GITHUB_REPOSITORY | cut -d '/' -f 2)
        echo "Formatted API docs:  https://$REPO_OWNER.github.io/$REPO_NAME/api-doc"
        echo ""
        echo "GitHub pages branch: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/tree/gh-pages" 